<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="前端">
    <meta name="author" content="Gary">
    
    <title>
        
            学用Hooks写React组件——基础版移动端无缝轮播图组件 |
        
        随记
    </title>
    
<link rel="stylesheet" href="/blog/css/style.css">

    <link rel="shortcut icon" href="/blog/images/logo.svg">
    
<link rel="stylesheet" href="/blog/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"wenlei0617.github.io","root":"/blog/","language":"zh-CN"};
    KEEP.theme_config = {"toc":{"enable":false,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/blog/images/bg.svg","description":"心怀热爱，奔赴山海"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                随记
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/blog/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/blog/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/blog/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/blog/archives">归档</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">学用Hooks写React组件——基础版移动端无缝轮播图组件</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/blog/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Gary</span>
                        
                            <span class="author-label">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2019-12-02 18:11:06</span>
        <span class="mobile">2019-12-02 18:11</span>
    </span>
    
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>最近忙于写业务代码和修改上古MPA的JS页面，对React欠缺使用和学习，感觉自己都快写不来代码了。拿来主义思想占据了思维，所以还是要造造轮子。因为最近在做移动端的东西，所以尝试写一个移动端的无缝轮播图，当前版本只支持手势切换和点击切换功能。文章主要包括从简单雏形到最终效果所有的思路和代码。</p>
</blockquote>
<h2 id="简单效果图"><a href="#简单效果图" class="headerlink" title="简单效果图"></a>简单效果图</h2><p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/30/16ebcf1383d8a873~tplv-t2oaga2asx-image.image"></p>
<h2 id="设计思路"><a href="#设计思路" class="headerlink" title="设计思路"></a>设计思路</h2><p>问：无缝轮播需要解决的问题在于，切换到最后一个轮播图时，如何<font color="red"><b>流畅</b></font>的到达第一个？</p>
<p><b>答：核心思想是利用视觉上的感觉，在用户无感的情况下切换回去，也就是快速回滚。为了达成这个目的，就是在最后一个轮播图的后面加上第一个轮播图，当从最后一个切换到第一个时，先切换到备用的第一个，然后快速回滚到真正的第一个轮播图。第一个同理，可能有点绕，可以看图理解：</b></p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ebd1c06fc260a4~tplv-t2oaga2asx-image.image"><br>布局思路就是这样，这样布局也就是需要多增加一个轮播子组件，如果子组件的布局复杂(类似卡片或者其他复杂组件)，就有点浪费资源，为了减少不必要dom的渲染，可以使用类似摩天轮的方式，循环补位，本质上思路不变，只是当在最后一个轮播图时，把第一个轮播图移动到它的后面，然后瞬间把第一个轮播图又移动到第一个位置。第一个轮播图同理。文字描述不好理解，还是看图说话吧：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/1/16ebd1c5ee50ed27~tplv-t2oaga2asx-image.image"></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h4 id="布局"><a href="#布局" class="headerlink" title="布局"></a>布局</h4><p>先创建一个外层包裹容器，也就是可视区容器，然后使用一个包裹容器把所有的轮播子组件进行包裹，之后轮播图的滚动都是控制包裹容器的位置来进行切换的。轮播图子组件需要位置可移动所以都使用绝对定位。点击按钮单独呈现，代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/* 可视区容器 */</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    /* 包裹容器 */</span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>1<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>2<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>3<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    /* 按钮容器 */</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span>&gt;</span>Left<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span>&gt;</span>Right<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h4><p>其实轮播图核心功能就是切换。只是切换的方式不同，比如点击切换、手势切换、自动切换，所以我们先从基础的切换入手。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useEffect, useRef &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./index.css&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Carousel</span> = (<span class="params">&#123;children, selectedIndex = <span class="number">1</span>&#125;</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 当切换的时候，改变的就是当前位置状态</span></span><br><span class="line">    <span class="comment">// 所以定义当前位置,可以通过传入的selectedIndex来控制最开始显示第几个轮播图,默认从1开始</span></span><br><span class="line">    <span class="keyword">const</span> [active, setActive] = <span class="title function_">useState</span>(selectedIndex);</span><br><span class="line">    <span class="comment">// 获取包裹容器</span></span><br><span class="line">    <span class="keyword">const</span> container = <span class="title function_">useRef</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 获取当前可视区容器宽度</span></span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">SCREEN_WIDTH</span> = <span class="variable language_">window</span>.<span class="property">screen</span>.<span class="property">width</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 统一处理，当active发生变化的时候，我们需要做的就是切换轮播图到某个位置,转场通过控制包裹容器的transform来进行切换，对transform的控制封装成setTransition函数</span></span><br><span class="line">    <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">setTransition</span>();</span><br><span class="line">    &#125;, [active]);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">setTransition</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 计算需要移动的距离并进行修改，这是切换的核心</span></span><br><span class="line">        <span class="keyword">const</span> distance = (<span class="number">1</span> - active) * <span class="variable constant_">SCREEN_WIDTH</span>;</span><br><span class="line">        container.<span class="property">current</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">`translate3d(<span class="subst">$&#123;distance&#125;</span>px, 0, 0)`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 为了演示是否成功，添加两个按钮来切换</span></span><br><span class="line">    <span class="comment">// 上一页</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handlePrev</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 对临界值进行处理</span></span><br><span class="line">        <span class="title function_">setActive</span>(active === <span class="number">1</span> ? children.<span class="property">length</span> : active - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 下一页</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleNext</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 对临界值进行处理</span></span><br><span class="line">        <span class="title function_">setActive</span>(active === children.<span class="property">length</span> ? <span class="number">1</span> : active + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;style.carousel&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">ref</span>=<span class="string">&#123;container&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">className</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;</span></span><br><span class="line"><span class="language-xml">                    React.Children.map(children, (child, index) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">                        return (</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">div</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                <span class="attr">style</span>=<span class="string">&#123;&#123;left:</span> <span class="attr">index</span> * <span class="attr">SCREEN_WIDTH</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                <span class="attr">className</span>=<span class="string">&#123;styles.items&#125;</span>&gt;</span>&#123;child&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        )</span></span><br><span class="line"><span class="language-xml">                    &#125;)</span></span><br><span class="line"><span class="language-xml">                &#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;handlePrev&#125;</span> <span class="attr">className</span>=<span class="string">&#123;styles.buttonLeft&#125;</span>&gt;</span>Left<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;handleNext&#125;</span> <span class="attr">className</span>=<span class="string">&#123;styles.buttonRight&#125;</span>&gt;</span>Right<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>附css代码</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.carousel</span>&#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.container</span>&#123;</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">translate3d</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="attribute">transition-duration</span>: <span class="number">1s</span>;</span><br><span class="line">    <span class="attribute">transition-property</span>: all;</span><br><span class="line">    <span class="attribute">transition-timing-function</span>: ease;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.items</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">flex-shrink</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.buttonLeft</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">margin</span>: auto;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.buttonRight</span> &#123;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">margin</span>: auto;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#fff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如图：</p>
<p><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/11/30/16ebd034c69775c4~tplv-t2oaga2asx-image.image"><br>这样就完成了基本的切换了。但是还没有实现无缝切换，最后一个切换到第一个的时候我们还没有用上面的思路进行处理。现在开始处理无缝的问题,主要处理如何循环补位能达到瞬间转换的效果，我这里是使用container.current.style.transitionProperty &#x3D; ‘none’关闭动画来进行瞬间切换。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Carousel</span> = (<span class="params">&#123;children, selectedIndex = <span class="number">1</span>&#125;</span>) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 创建一个参数，对轮播图的状态进行控制  1为静止，2为进行中。主要目的是避免快速切换导致的bug。</span></span><br><span class="line">    <span class="comment">// 所以只有在动画结束过后，也就是静止的时候才能再次切换轮播图</span></span><br><span class="line">    <span class="keyword">const</span> [status, setStatus] = <span class="title function_">useState</span>(<span class="number">1</span>);</span><br><span class="line">    ...</span><br><span class="line">    ...相同代码省略</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 因为要达到流畅的切换，已当前为第一个轮播图为例，向左切换时，最后一个轮播图补位，然后瞬间归位(在此时取消过渡动画，完成流畅切换); 对setTransition进行修改并新增offset参数对函数进行增强，后面具体会讲到此参数的作用。</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">setTransition</span> = (<span class="params">offset = <span class="number">0</span></span>) =&gt; &#123;</span><br><span class="line">        ...新增的代码</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">transitionend</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="comment">// 动画结束后就关闭动画</span></span><br><span class="line">            container.<span class="property">current</span>.<span class="property">style</span>.<span class="property">transitionProperty</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">            <span class="comment">// 恢复状态为1静止</span></span><br><span class="line">            <span class="title function_">setStatus</span>(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 当前位置在补位的位置时马上切换到本该在的位置</span></span><br><span class="line">            <span class="keyword">if</span> (active === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 使用setTimeout包裹，避免transitionProperty动画未关闭就切换的闪频</span></span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">setActive</span>(children.<span class="property">length</span>);</span><br><span class="line">                &#125;, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (active === children.<span class="property">length</span> + <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="title function_">setActive</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            container.<span class="property">current</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;transitionend&#x27;</span>, transitionend, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        container.<span class="property">current</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;transitionend&#x27;</span>, transitionend, <span class="literal">false</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> distance = (<span class="number">1</span> - active) * <span class="variable constant_">SCREEN_WIDTH</span>;</span><br><span class="line">        ...修改的代码，新增offset</span><br><span class="line">        container.<span class="property">current</span>.<span class="property">style</span>.<span class="property">transform</span> = <span class="string">`translate3d(<span class="subst">$&#123;distance+offset&#125;</span>px,0,0)`</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...新增代码，封装对active修改的操作</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleChangeActive</span> = (<span class="params">number</span>) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 当在动画进行时，不允许切换</span></span><br><span class="line">        <span class="keyword">if</span> (status === <span class="number">2</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// 切换前先把动画参数打开</span></span><br><span class="line">        container.<span class="property">current</span>.<span class="property">style</span>.<span class="property">transitionProperty</span> = <span class="string">&#x27;all&#x27;</span>;</span><br><span class="line">        <span class="comment">// 修改状态为进行时</span></span><br><span class="line">        <span class="title function_">setStatus</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 改变当前位置</span></span><br><span class="line">        <span class="title function_">setActive</span>(number);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...修改的代码</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handlePrev</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 根据之前的理论，当前位置如果是第一个的情况下，最后一个轮播图会跳到第一个的前面</span></span><br><span class="line">        <span class="comment">// 切换到前面的时候active就要减去到0才能到达位置，所以对此进行修改，并使用前面封装的handleChangeActive方法进行包裹</span></span><br><span class="line">        <span class="comment">// 之前的代码</span></span><br><span class="line">        <span class="comment">// setActive(active === 1 ? children.length : active - 1)；</span></span><br><span class="line">        <span class="comment">// 修改过后的代码</span></span><br><span class="line">        <span class="title function_">handleChangeActive</span>(active === <span class="number">0</span> ? children.<span class="property">length</span> : active - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleNext</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 此处同上同理</span></span><br><span class="line">        <span class="comment">// 之前的代码</span></span><br><span class="line">        <span class="comment">// setActive(active === children.length ? 1 : active + 1);</span></span><br><span class="line">        <span class="title function_">handleChangeActive</span>(active === children.<span class="property">length</span> + <span class="number">1</span> ? <span class="number">1</span> : active + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.carousel&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">ref</span>=<span class="string">&#123;container&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">className</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;</span></span><br><span class="line"><span class="language-xml">                    React.Children.map(children, (child, index) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">                        ...修改的代码</span></span><br><span class="line"><span class="language-xml">                        // 当轮播图处于第一个时，最后一个组件时，提取到最前面去</span></span><br><span class="line"><span class="language-xml">                        if (active &lt;= 1 &amp;&amp; index + 1 === children.length) &#123;</span></span><br><span class="line"><span class="language-xml">                            return (</span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;left:</span> <span class="attr">-1</span> * <span class="attr">SCREEN_WIDTH</span>&#125;&#125; <span class="attr">className</span>=<span class="string">&#123;styles.items&#125;</span>&gt;</span>&#123;child&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            )</span></span><br><span class="line"><span class="language-xml">                        &#125;</span></span><br><span class="line"><span class="language-xml">                        // 当轮播图处于最后一个时，第一个组件提取到最后面</span></span><br><span class="line"><span class="language-xml">                        if (active &gt;= children.length &amp;&amp; index === 0) &#123;</span></span><br><span class="line"><span class="language-xml">                            return (</span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;left:</span> <span class="attr">children.length</span> * <span class="attr">SCREEN_WIDTH</span>&#125;&#125; <span class="attr">className</span>=<span class="string">&#123;styles.item&#125;</span>&gt;</span>&#123;child&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            )</span></span><br><span class="line"><span class="language-xml">                        &#125;</span></span><br><span class="line"><span class="language-xml">                        return (</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">div</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                <span class="attr">style</span>=<span class="string">&#123;&#123;left:</span> <span class="attr">index</span> * <span class="attr">SCREEN_WIDTH</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                <span class="attr">className</span>=<span class="string">&#123;styles.items&#125;</span>&gt;</span>&#123;child&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        )</span></span><br><span class="line"><span class="language-xml">                    &#125;)</span></span><br><span class="line"><span class="language-xml">                &#125;    </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里无缝轮播就算大功告成。之后就是对轮播图进行扩展了。不管怎么切换，使用核心的两个函数就可以解决大部分功能需求(setTransition、handleChangeActive)。现在我们再对此进行增加，加入手势的滑动,这里我引入了第三方库hammerjs来作为手势的处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">...相同代码省略</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Hammer</span> <span class="keyword">from</span> <span class="string">&#x27;hammerjs&#x27;</span>;</span><br><span class="line">...</span><br><span class="line">...相同代码省略</span><br><span class="line">...</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cosnt manager = <span class="keyword">new</span> <span class="title class_">Hammer</span>(container.<span class="property">current</span>);</span><br><span class="line">    manager.<span class="title function_">add</span>(<span class="keyword">new</span> <span class="title class_">Hammer</span>.<span class="title class_">Pan</span>());</span><br><span class="line">    manager.<span class="title function_">on</span>(<span class="string">&#x27;panend panmove&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="comment">// 状态在进行中时，不允许切换</span></span><br><span class="line">        <span class="keyword">if</span> (status === <span class="number">2</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="comment">// e.eventType 判断当前状态  </span></span><br><span class="line">        <span class="comment">// INPUT_MOVE 移动中  </span></span><br><span class="line">        <span class="comment">// INPUT_END 结束</span></span><br><span class="line">        <span class="keyword">if</span> (e.<span class="property">eventType</span> === <span class="title class_">Hammer</span>.<span class="property">INPUT_MOVE</span>) &#123;</span><br><span class="line">            <span class="comment">// 之前的offset参数的在此起到了作用，在手动滑动的时候并不是直接滑动到下一页，只是跟随手指进行偏移量改变</span></span><br><span class="line">            <span class="title function_">setTransition</span>(e.<span class="property">deltaX</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">eventType</span> === <span class="title class_">Hammer</span>.<span class="property">INPUT_END</span>) &#123;</span><br><span class="line">            <span class="comment">// e.direction 判断移动方向</span></span><br><span class="line">            <span class="comment">// Hammer.DIRECTION_LEFT 向左</span></span><br><span class="line">            <span class="comment">// Hammer.DIRECTION_RIGHT 向右</span></span><br><span class="line">            <span class="comment">// 当滑动距离大于1/3时，直接滑动到下一页，否则恢复偏移量</span></span><br><span class="line">            <span class="keyword">if</span> (e.<span class="property">direction</span> === <span class="title class_">Hammer</span>.<span class="property">DIRECTION_LEFT</span> &amp;&amp; <span class="title class_">Math</span>.<span class="title function_">abs</span>(e.<span class="property">deltaX</span>) &gt; <span class="variable constant_">SCREEN_WIDTH</span> / <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="title function_">handleNext</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">direction</span> === <span class="title class_">Hammer</span>.<span class="property">DIRECTION_RIGHT</span> &amp;&amp; <span class="title class_">Math</span>.<span class="title function_">abs</span>(e.<span class="property">deltaX</span>) &gt; <span class="variable constant_">SCREEN_WIDTH</span> / <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="title function_">handlePrev</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">setTransition</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            manager.<span class="title function_">off</span>(<span class="string">&#x27;panmove&#x27;</span>);</span><br><span class="line">            manager.<span class="title function_">off</span>(<span class="string">&#x27;panend&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">&#125;, [status, active])</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>手势切换也加上了。其它方式的切换道理也是一样的。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到这里，一个简易版的移动端手势滚动组件就完成了，里面还有很多的不足、功能缺陷和优化点，例如容器宽度和高度的判断，宽度直接取得手机宽度，高度我直接写死的；轮播子组件的懒加载等等，之后也会慢慢进行增强和优化。毕竟路漫漫其修远兮。如果这篇文章的思路能对你有所帮助，不妨点个喜欢。</p>

        </div>

        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/blog/2020/08/17/%E5%AD%A6%E7%94%A8Hook%E5%86%99React%E7%BB%84%E4%BB%B6%E2%80%94%E2%80%94%E9%80%9A%E7%94%A8%E5%BC%B9%E5%87%BA%E5%B1%82/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">学用Hook写React组件——通用弹出层</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/blog/2019/08/20/%E5%AD%A6%E7%94%A8Hooks%E5%86%99React%E7%BB%84%E4%BB%B6%E2%80%94%E2%80%94%E5%9F%BA%E7%A1%80%E7%89%88Select%E7%BB%84%E4%BB%B6/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">学用Hooks写React组件——基础版Select组件</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Gary</a>
        </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>




<script src="/blog/js/utils.js"></script>

<script src="/blog/js/main.js"></script>

<script src="/blog/js/header-shrink.js"></script>

<script src="/blog/js/back2top.js"></script>

<script src="/blog/js/dark-light-toggle.js"></script>








<div class="post-scripts">
    
</div>



</body>
</html>
